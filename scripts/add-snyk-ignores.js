#!/usr/bin/env node

/**
 * Script to add Snyk ignore rules for documented false positives
 * 
 * This script helps add ignore rules for known false positives that are
 * properly mitigated in the codebase.
 * 
 * Usage:
 *   node scripts/add-snyk-ignores.js
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// False positives to ignore (documented in .snyk and SECURITY_REPORT.md)
const falsePositives = [
  {
    file: 'app/(dashboard)/alerts/page.tsx',
    line: 372,
    rule: 'javascript/DOMXSS',
    reason: 'Uses validateSafeUrl() before setting href attribute - properly mitigated',
  },
  {
    file: 'app/(dashboard)/editor/page.tsx',
    line: 366,
    rule: 'javascript/DOMXSS',
    reason: 'Uses blob URLs from createObjectURL() which are browser-generated and safe',
  },
  {
    file: 'components/analytics/report-builder.tsx',
    line: 307,
    rule: 'javascript/DOMXSS',
    reason: 'Uses blob URLs from createObjectURL() which are browser-generated and safe',
  },
  {
    file: 'components/settings/privacy-settings-manager.tsx',
    line: 127,
    rule: 'javascript/DOMXSS',
    reason: 'Uses blob URLs from createObjectURL() which are browser-generated and safe',
  },
  {
    file: 'components/core/ui/layout/image-gallery.tsx',
    line: 134,
    rule: 'javascript/DOMXSS',
    reason: 'Uses blob URLs from createObjectURL() which are browser-generated and safe',
  },
  {
    file: 'components/security/mfa-settings.tsx',
    line: 318,
    rule: 'javascript/DOMXSS',
    reason: 'QR code URL from trusted MFA service (otplib) - no user input involved',
  },
  {
    file: 'components/core/enhanced-notifications-panel.tsx',
    line: 203,
    rule: 'javascript/OR',
    reason: 'Uses validateSafeUrl() which validates URLs before redirect - properly mitigated',
  },
  {
    file: 'lib/clerk-theme.ts',
    line: 129,
    rule: 'javascript/NoHardcodedPasswords',
    reason: 'False positive: formFieldInputShowPasswordButton is a CSS class name prop, not a hardcoded password',
  },
  {
    file: 'scripts/check-external-links.js',
    line: 156,
    rule: 'javascript/HttpToHttps',
    reason: 'Development/test script - uses HTTPS when URL protocol is https:, HTTP only for localhost testing',
  },
];

console.log('üîç Fetching Snyk issue IDs...\n');

try {
  // Run Snyk test to get issue IDs
  const output = execSync('snyk code test --json', { 
    encoding: 'utf-8',
    stdio: 'pipe',
    cwd: process.cwd(),
  });

  const results = JSON.parse(output);
  const issues = results.runs[0].results || [];

  console.log(`Found ${issues.length} total issues\n`);

  // Find matching issues
  const matches = [];
  
  for (const fp of falsePositives) {
    const matchingIssues = issues.filter(issue => {
      const location = issue.locations[0]?.physicalLocation;
      if (!location) return false;
      
      const uri = location.artifactLocation.uri;
      const line = location.region.startLine;
      const ruleId = issue.ruleId;
      
      // Match file (handle URL encoding) and line number
      const normalizedUri = decodeURIComponent(uri);
      const normalizedFile = fp.file.replace(/\(/g, '%28').replace(/\)/g, '%29');
      
      return (
        (uri.includes(fp.file) || normalizedUri.includes(fp.file) || uri.includes(normalizedFile)) &&
        line === fp.line &&
        ruleId === fp.rule
      );
    });

    if (matchingIssues.length > 0) {
      matches.push({
        falsePositive: fp,
        issue: matchingIssues[0],
      });
    } else {
      console.log(`‚ö†Ô∏è  No match found for ${fp.file}:${fp.line} (${fp.rule})`);
    }
  }

  if (matches.length === 0) {
    console.log('‚ùå No matching issues found. They may have been fixed or already ignored.');
    process.exit(0);
  }

  console.log(`\n‚úÖ Found ${matches.length} matching issues to ignore:\n`);

  // Generate ignore commands
  const expiryDate = new Date();
  expiryDate.setFullYear(expiryDate.getFullYear() + 1); // 1 year from now
  const expiry = expiryDate.toISOString().split('T')[0];

  console.log('Run these commands to ignore the false positives:\n');
  console.log('# Generated by scripts/add-snyk-ignores.js');
  console.log(`# Date: ${new Date().toISOString()}\n`);

  for (const match of matches) {
    const { falsePositive: fp, issue } = match;
    const issueId = issue.fingerprints?.values?.v1 || 
                   `${issue.ruleId}|${issue.locations[0].physicalLocation.artifactLocation.uri}|${issue.locations[0].physicalLocation.region.startLine}`;
    
    console.log(`snyk ignore --id="${issueId}" \\`);
    console.log(`  --reason="${fp.reason}" \\`);
    console.log(`  --expiry="${expiry}"`);
    console.log('');
  }

  console.log('\nüí° Tip: You can also run this script with --auto to automatically add ignores');
  console.log('   (requires Snyk CLI to be authenticated and proper permissions)\n');

  // Auto-add if flag is set
  if (process.argv.includes('--auto')) {
    console.log('üöÄ Auto-adding ignore rules...\n');
    
    for (const match of matches) {
      const { falsePositive: fp, issue } = match;
      const issueId = issue.fingerprints?.values?.v1 || 
                     `${issue.ruleId}|${issue.locations[0].physicalLocation.artifactLocation.uri}|${issue.locations[0].physicalLocation.region.startLine}`;
      
      try {
        execSync(`snyk ignore --id="${issueId}" --reason="${fp.reason}" --expiry="${expiry}"`, {
          stdio: 'inherit',
          cwd: process.cwd(),
        });
        console.log(`‚úÖ Ignored: ${fp.file}:${fp.line}\n`);
      } catch (error) {
        console.error(`‚ùå Failed to ignore ${fp.file}:${fp.line}:`, error.message);
      }
    }
    
    console.log('\n‚úÖ Done! False positives have been ignored.');
  }

} catch (error) {
  console.error('‚ùå Error:', error.message);
  console.error('\nMake sure Snyk CLI is installed and authenticated:');
  console.error('  npm install -g snyk');
  console.error('  snyk auth');
  process.exit(1);
}

